import{_ as s,o as a,c as n,V as l}from"./chunks/framework.b450deef.js";const C=JSON.parse('{"title":"treeShaking","description":"","frontmatter":{},"headers":[],"relativePath":"articles/03-æ¶æ„/è®¾è®¡/treeShakingåŸç†.md","filePath":"articles/03-æ¶æ„/è®¾è®¡/treeShakingåŸç†.md"}'),o={name:"articles/03-æ¶æ„/è®¾è®¡/treeShakingåŸç†.md"},p=l(`<h1 id="treeshaking" tabindex="-1">treeShaking <a class="header-anchor" href="#treeshaking" aria-label="Permalink to &quot;treeShaking&quot;">â€‹</a></h1><h2 id="treeshaking-åŸç†" tabindex="-1">treeShaking åŸç† <a class="header-anchor" href="#treeshaking-åŸç†" aria-label="Permalink to &quot;treeShaking åŸç†&quot;">â€‹</a></h2><p>å¾ˆå¤šæ–‡ç« ä»¥åŠæ‰“åŒ…å·¥å…·ä»‹ç» <code>tree-shaking</code> åŠŸèƒ½éƒ½æ˜¯è®²è§£å®ƒçš„ç°è±¡ã€æ•ˆæœå’Œå¿…é¡»åŸºäº <code>ESM</code></p><p>å°±ä»¿ä½›åªè¦ç”¨äº† <code>ESM</code> é‚£ä¹ˆ <code>tree-shaking</code> å°±æ˜¯è‡ªåŠ¨å®ç°çš„</p><ul><li><a href="https://webpack.js.org/guides/tree-shaking/" target="_blank" rel="noreferrer">webpack-treeshaking å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://rollupjs.org/guide/en/#tree-shaking" target="_blank" rel="noreferrer">rollup-treeshaking å®˜æ–¹æ–‡æ¡£</a></li></ul><blockquote><p>Rollup also <strong>statically analyzes the code</strong> you are importing, and will exclude anything that isn&#39;t actually used.</p><p>Since this approach can utilise explicit import and export statements, it is more effective than simply running an automated minifier to detect unused variables in the compiled output code.</p><p>ğŸ‘† <code>this approach</code> æŒ‡çš„æ˜¯Rollupå¯¹ç¼–è¯‘å‰çš„ä»£ç åš <code>statically analyzes the code</code></p><p>æ¯”ä¼ ç»Ÿçš„ <code>Webpack</code> ç”¨å‹ç¼©å™¨æ¥æ‰«æç¼–è¯‘åçš„ä»£ç å†…å®¹ä¸­æœªä½¿ç”¨çš„å˜é‡ è¦æ›´æœ‰æ•ˆ</p></blockquote><p>æˆ‘ä»¬éœ€è¦æ˜ç™½ <code>statically analyzes</code> æ˜¯ä¸€ä¸ªæ‰‹åŠ¨çš„æ­¥éª¤ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨çš„</p><p>å› ä¸º <strong>é™æ€åˆ†æ</strong> æ˜¯å¯¹ç¼–è¯‘å‰çš„ä»£ç åšæ‰«æå¤„ç†ï¼Œå› æ­¤æ¨¡å—åŒ–è¯­æ³•å¿…é¡»æ˜¯é™æ€çš„ï¼Œè€Œä¸æ˜¯éœ€è¦è¿è¡Œæ—¶æ‰èƒ½æ¸…æ™°çš„è¯­æ³•ï¼Œè¿™ä¹Ÿæ˜¯ <code>ESM</code> å¿…é¡»æ˜¯ç°ä»£æ‰“åŒ…å™¨ <code>tree-shaking</code> çš„å¤§å‰æ</p><p>è¿™ä¹Ÿæ˜¯è®¸å¤šæ–‡ç« è®²è§£ <code>tree-shaking</code> æ—¶ä¸»è¦è®²è§£çš„æ–¹å‘( <code>ESM</code> å’Œ <code>CJS</code> çš„é™æ€è¯­æ³•å’Œè¿è¡Œæ—¶è¯­æ³•åŒºåˆ« )</p><p>è¿™é‡Œèšç„¦åœ¨ <strong>é™æ€åˆ†æé€»è¾‘</strong>ï¼Œä¸ä¼šå¯¹å‰ç«¯æ¨¡å—åŒ–åšè¿‡å¤šè®²è§£ï¼Œå¯ç§»æ­¥ <a href="./../js/å‰ç«¯æ¨¡å—åŒ–.html">å‰ç«¯æ¨¡å—åŒ–</a></p><h2 id="æ‰‹å†™-statically-analyzes-é™æ€åˆ†æ" tabindex="-1">æ‰‹å†™ statically analyzes é™æ€åˆ†æ <a class="header-anchor" href="#æ‰‹å†™-statically-analyzes-é™æ€åˆ†æ" aria-label="Permalink to &quot;æ‰‹å†™ statically analyzes é™æ€åˆ†æ&quot;">â€‹</a></h2><h3 id="æµ‹è¯•ä»£ç " tabindex="-1">æµ‹è¯•ä»£ç  <a class="header-anchor" href="#æµ‹è¯•ä»£ç " aria-label="Permalink to &quot;æµ‹è¯•ä»£ç &quot;">â€‹</a></h3><p>ğŸ‘‡ <code>src/index.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">){</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mul</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">){</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> d</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">d)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>ğŸ‘‡ <code>dist/index.shaked.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">){</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> c</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> d</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(c</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">d)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="_0-æ­¥éª¤" tabindex="-1">0. æ­¥éª¤ <a class="header-anchor" href="#_0-æ­¥éª¤" aria-label="Permalink to &quot;0. æ­¥éª¤&quot;">â€‹</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> acorn </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">acorn</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">output</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">readEntrier</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./readWriterFile.js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">shaking</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./shaking.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 1. è¯»å–å…¥å£æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buffer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">readEntrier</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 2. ä»£ç å­—ç¬¦ä¸² è½¬åŒ–ä¸º AST æ•°æ®</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> body </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> acorn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(buffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">ecmaVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2020</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 3. æ­¥éª¤ï¼šæ‰«ææ‰€æœ‰å£°æ˜çš„å˜é‡ æ‰«ææ‰€æœ‰ä½¿ç”¨çš„å˜é‡ï¼ŒæŒ‰ç…§ä½¿ç”¨çš„å˜é‡ å– å¯¹åº”å£°æ˜çš„å˜é‡ï¼Œæœ€åæ‹¼æ¥æˆä¸€ä¸ª pure ä»£ç å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> afterShakingCodeStr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shaking</span><span style="color:#A6ACCD;">(body)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 4. æŠŠä»£ç å­—ç¬¦ä¸²å†™å…¥å‡ºå£æ–‡ä»¶</span></span>
<span class="line"><span style="color:#82AAFF;">output</span><span style="color:#A6ACCD;">(afterShakingCodeStr)</span></span></code></pre></div><p>ğŸ‘† åªèƒ½æ‘‡æ‰ä¸€ä¸ª <code>js</code> æ–‡ä»¶å†…çš„æœªä½¿ç”¨ä»£ç  <code>dead-code</code></p><p>æ²¡æœ‰å®ç°åˆ†æä¾èµ–ï¼Œå¹¶æ‘‡æ‰æœªä½¿ç”¨çš„æ¨¡å—</p><h3 id="_1-è¯»å–å…¥å£æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²" tabindex="-1">1. è¯»å–å…¥å£æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸² <a class="header-anchor" href="#_1-è¯»å–å…¥å£æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²" aria-label="Permalink to &quot;1. è¯»å–å…¥å£æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²&quot;">â€‹</a></h3><p><code>nodejs</code> çš„ <code>fs</code> è¯»å–å…¥å£æ–‡ä»¶ <code>src/index.js</code> çš„ä»£ç å†…å®¹</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> fs </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node:fs</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">readEntrier</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buffer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./src/index.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buffer</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="_2-ä»£ç å­—ç¬¦ä¸²-è½¬åŒ–ä¸º-ast-æ•°æ®" tabindex="-1">2. ä»£ç å­—ç¬¦ä¸² è½¬åŒ–ä¸º AST æ•°æ® <a class="header-anchor" href="#_2-ä»£ç å­—ç¬¦ä¸²-è½¬åŒ–ä¸º-ast-æ•°æ®" aria-label="Permalink to &quot;2. ä»£ç å­—ç¬¦ä¸² è½¬åŒ–ä¸º AST æ•°æ®&quot;">â€‹</a></h3><p>ç”¨ <code>acorn</code> ä¾èµ–åº“ï¼ŒæŠŠä»£ç å†…å®¹å­—ç¬¦ä¸²è½¬åŒ–ä¸º <code>ASTæ•°æ®</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> acorn </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">acorn</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> body </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> acorn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(buffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">ecmaVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2020</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230106143943.png" alt=""></p><h3 id="_3-æ ¹æ®-ast-æ‰¾å‡ºæœ‰è°ƒç”¨çš„ä»£ç å¹¶ç”Ÿæˆ-pure-ä»£ç å­—ç¬¦ä¸²" tabindex="-1">3. æ ¹æ® AST æ‰¾å‡ºæœ‰è°ƒç”¨çš„ä»£ç å¹¶ç”Ÿæˆ pure ä»£ç å­—ç¬¦ä¸² <a class="header-anchor" href="#_3-æ ¹æ®-ast-æ‰¾å‡ºæœ‰è°ƒç”¨çš„ä»£ç å¹¶ç”Ÿæˆ-pure-ä»£ç å­—ç¬¦ä¸²" aria-label="Permalink to &quot;3. æ ¹æ® AST æ‰¾å‡ºæœ‰è°ƒç”¨çš„ä»£ç å¹¶ç”Ÿæˆ pure ä»£ç å­—ç¬¦ä¸²&quot;">â€‹</a></h3><p>æ ¹æ® <code>AST</code> æ•°æ®ï¼Œæ‰¾å‡º</p><ul><li>æ‰€æœ‰å£°æ˜å‡½æ•°å’Œå˜é‡ <code>declarationList</code> å­˜å‚¨ <code>{ key:å˜é‡å value:å…·ä½“å£°æ˜ä»£ç  }</code></li><li>æ‰€ä½¿ç”¨è°ƒç”¨è¿‡çš„å˜é‡å <code>calledDeclarationList</code> å­˜å‚¨ <code>[å˜é‡å, å˜é‡å, ...]</code></li><li>å…¶å®ƒéå£°æ˜çš„ä»£ç  <code>code</code> å­˜å‚¨ <code>[ä»£ç è¯­å¥, ...]</code></li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">astToCodeString</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">visitNode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">visitVariableDeclarator</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">visitIdentifier</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./astToCodeString.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">shaking</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">astBody</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ‰€æœ‰å£°æ˜å‡½æ•°å’Œå˜é‡ \`declarationList\` å­˜å‚¨ \`{ key:å˜é‡å value:å…·ä½“å£°æ˜ä»£ç  }\`</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ‰€ä½¿ç”¨è°ƒç”¨è¿‡çš„å˜é‡å \`calledDeclarationList\` å­˜å‚¨ \`[å˜é‡å, å˜é‡å, ...]\`</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å…¶å®ƒéå£°æ˜çš„ä»£ç  \`code\` å­˜å‚¨ \`[ä»£ç è¯­å¥, ...]\`</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">declarationList</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Map</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">calledDeclarationList</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> []</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">astBody</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">node</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å‡½æ•°å£°æ˜ å­˜æ”¾åˆ° declarationList çš„ Map ä¸­</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FunctionDeclaration</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">astToCodeString</span><span style="color:#F07178;">([</span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">declarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">visitNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å˜é‡å£°æ˜è¡¨è¾¾å¼ï¼Œkind å±æ€§è¡¨ç¤ºæ˜¯ä»€ä¹ˆç±»å‹çš„å£°æ˜ï¼Œå€¼å¯èƒ½æ˜¯var/const/let</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// declarations æ•°ç»„ è¡¨ç¤ºå£°æ˜çš„å¤šä¸ªæè¿°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼šlet a = 1, b = 2</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å­˜æ”¾åˆ° declarationList çš„ Map ä¸­</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">VariableDeclaration</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">kind</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">decl</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">declarations</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">declarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">visitNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">decl</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">visitVariableDeclarator</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">decl</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">kind</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ExpressionStatement</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ï¼šsetTimeout(()=&gt;{})</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// callee å±æ€§æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// arguments æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…ƒç´ æ˜¯è¡¨è¾¾å¼èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå‡½æ•°å‚æ•°åˆ—è¡¨</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">expression</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">CallExpression</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callNode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">expression</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">calledDeclarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">visitIdentifier</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">callNode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">callee</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">callNode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">arguments</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">arg</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Identifier</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">calledDeclarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">visitNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">arg</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Identifier- æ ‡è¯†ç¬¦ï¼Œå°±æ˜¯æˆ‘ä»¬å†™ JS æ—¶è‡ªå®šä¹‰çš„åç§°ï¼Œå¦‚å˜é‡åï¼Œå‡½æ•°åï¼Œå±æ€§åï¼Œéƒ½å½’ä¸ºæ ‡è¯†ç¬¦</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// è¡¨ç¤ºçš„æ˜¯ä½¿ç”¨å˜é‡ï¼Ÿ å­˜æ”¾åˆ° calledDeclarationList æ•°ç»„ä¸­</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Identifier</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">calledDeclarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">code</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">astToCodeString</span><span style="color:#F07178;">([</span><span style="color:#A6ACCD;">node</span><span style="color:#F07178;">]))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘† è‡³æ­¤ä¸€ä¸ªå…¥å£æ–‡ä»¶çš„å˜é‡æ˜¯å¦è¢«è°ƒç”¨è¿‡(æœ‰æ•ˆä»£ç )çš„å…³ç³»å·²ç»æ¸…æ™°äº†</p><p>éå†è°ƒç”¨çš„å˜é‡åæ•°ç»„ å»æ‰€æœ‰å£°æ˜å‡½æ•°å’Œå˜é‡ <code>declarationList</code> ä¸­æ ¹æ®å˜é‡åkeyï¼Œå–å‡ºå¯¹åº”çš„ä»£ç value</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> afterShakingCodeList </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">(calledDeclarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#A6ACCD;">( </span><span style="color:#A6ACCD;font-style:italic;">c</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> declarationList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#A6ACCD;">(c) ))</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">code</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> afterShakingCodeList </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> afterShakingCodeList</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230106154405.png" alt=""></p><h3 id="_4-æŠŠä»£ç å­—ç¬¦ä¸²å†™å…¥å‡ºå£æ–‡ä»¶" tabindex="-1">4. æŠŠä»£ç å­—ç¬¦ä¸²å†™å…¥å‡ºå£æ–‡ä»¶ <a class="header-anchor" href="#_4-æŠŠä»£ç å­—ç¬¦ä¸²å†™å…¥å‡ºå£æ–‡ä»¶" aria-label="Permalink to &quot;4. æŠŠä»£ç å­—ç¬¦ä¸²å†™å…¥å‡ºå£æ–‡ä»¶&quot;">â€‹</a></h3><p>æœ€åæŠŠè¿™äº›ä»£ç æ•°ç»„æ‹¼æ¥åˆ°å­—ç¬¦ä¸²ï¼Œå†™è¿›ä¸€ä¸ªç»“æœæ–‡ä»¶</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">output</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">code</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeFileSync</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/index.shaked.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><a href="https://github.com/luojinan/note-by-vitepress/tree/master/test/tree-shaking" target="_blank" rel="noreferrer">demo-github</a></p><h2 id="æ€»ç»“" tabindex="-1">æ€»ç»“ <a class="header-anchor" href="#æ€»ç»“" aria-label="Permalink to &quot;æ€»ç»“&quot;">â€‹</a></h2><p>å¯ä»¥çœ‹å‡º é™æ€åˆ†æ <code>statically analyzes</code></p><ul><li>é‡ç‚¹åœ¨æ‰¾å‡ºä¼šè¢«è°ƒç”¨çš„<strong>æœ‰æ•ˆä»£ç </strong>ï¼ŒåŸºäº <code>ASTæ•°æ®</code></li><li>éš¾ç‚¹åœ¨äºè¿™ä¸ªæ‰«æçš„ç®—æ³•</li><li>è€ŒğŸ‘† è¿™ä¸ªæ­¥éª¤æåº¦ä¾èµ–ä»£ç çš„é™æ€æ€§ï¼Œå¦‚æœè¢«è°ƒç”¨è¿™ä»¶äº‹æ˜¯ä¸å¯ç¡®å®šçš„ï¼Œé‚£ä¹ˆ <code>tree-shaking</code> ä¹Ÿå°†æ— ä»ä¸‹æ‰‹</li></ul><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1">å‚è€ƒèµ„æ–™ <a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-label="Permalink to &quot;å‚è€ƒèµ„æ–™&quot;">â€‹</a></h2><ul><li><a href="https://zhuanlan.zhihu.com/p/344539451" target="_blank" rel="noreferrer">ç”¨jsæ„å»ºä¸€ä¸ªç®€å•çš„Tree-shakingå·¥å…·ï¼ˆè¯‘ï¼‰</a></li></ul>`,44),e=[p];function t(c,r,y,F,D,i){return a(),n("div",null,e)}const d=s(o,[["render",t]]);export{C as __pageData,d as default};
