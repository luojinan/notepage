import{_ as s,o as n,c as a,V as l}from"./chunks/framework.b450deef.js";const C=JSON.parse('{"title":"viteæºç åˆ†æ","description":"","frontmatter":{},"headers":[],"relativePath":"articles/03-æ¶æ„/vite/æºç åˆ†æ.md","filePath":"articles/03-æ¶æ„/vite/æºç åˆ†æ.md"}'),p={name:"articles/03-æ¶æ„/vite/æºç åˆ†æ.md"},o=l(`<h1 id="viteæºç åˆ†æ" tabindex="-1">viteæºç åˆ†æ <a class="header-anchor" href="#viteæºç åˆ†æ" aria-label="Permalink to &quot;viteæºç åˆ†æ&quot;">â€‹</a></h1><blockquote><p>Vite consists of two major parts:</p><ul><li>A dev server <ul><li>provides rich feature enhancements over native ES modules, for example extremely fast Hot Module Replacement (HMR).</li></ul></li><li>A build command <ul><li>bundles your code with Rollup,</li><li>pre-configured to output highly optimized static assets for production.</li></ul></li></ul></blockquote><p>ğŸ‘† å¯ä»¥ä»2æ–¹é¢å¯¹æºç è¿›è¡Œåˆ†æï¼Œ1. vite-dev-server 2. rollupçš„å†…ç½®é…ç½®</p><h2 id="åˆå§‹åŒ–tsç¯å¢ƒ" tabindex="-1">åˆå§‹åŒ–tsç¯å¢ƒ <a class="header-anchor" href="#åˆå§‹åŒ–tsç¯å¢ƒ" aria-label="Permalink to &quot;åˆå§‹åŒ–tsç¯å¢ƒ&quot;">â€‹</a></h2><p><code>tsconfig.json</code></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">compilerOptions</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">target</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ESNext</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">useDefineForClassFields</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ESNext</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">moduleResolution</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Node</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">strict</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">resolveJsonModule</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">isolatedModules</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">esModuleInterop</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">lib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ESNext</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">skipLibCheck</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">noEmit</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">include</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">src/**/*.ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">src/**/*.d.ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘† å¤åˆ¶viteåˆ›å»ºåŸç”Ÿtsé¡¹ç›®æ—¶çš„é…ç½®</p><p>ğŸ‘‡ å› ä¸ºæ˜¯çº¯nodeæœåŠ¡ï¼Œå› æ­¤é…ç½® <code>package.json</code> ä¸ºesmæ¨¡å¼</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">,</span></span></code></pre></div><p>å¹¶ä¸”å®‰è£… <code>esno</code> ä¾èµ–ï¼Œç”¨äºåœ¨ <code>nodejs</code> ç¯å¢ƒæ‰§è¡Œ <code>ts</code></p><p>ğŸ¤” <code>es-node</code> ä¸å¥½ç”¨ï¼Œ2è€…çš„åŒºåˆ«TODO:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">dev</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">npx esno ./src/index.ts</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><h2 id="åˆ›å»ºé™æ€æœåŠ¡" tabindex="-1">åˆ›å»ºé™æ€æœåŠ¡ <a class="header-anchor" href="#åˆ›å»ºé™æ€æœåŠ¡" aria-label="Permalink to &quot;åˆ›å»ºé™æ€æœåŠ¡&quot;">â€‹</a></h2><p>ğŸ‘‡ <code>src/index.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// å¤„ç†å‘½ä»¤è¡Œå‚æ•°-ç•¥</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> run </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¼‚æ­¥åŠ è½½æ ¸å¿ƒä»£ç çš„åŸå› æ˜¯ï¼Œæ ¹æ®å‘½ä»¤ä¸åŒæ‰§è¡Œä¸åŒçš„æ“ä½œå¦‚build/devç­‰</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å„æ ¸å¿ƒä»£ç å¤æ‚ä¸”ä¸ç›¸å…³ï¼Œå› æ­¤æ‰‹åŠ¨æŒ‰éœ€åŠ è½½</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// TODO: åˆ¤æ–­å¦‚æœæ²¡æœ‰httpsOptionæ—¶åˆ›å»ºæ™®é€šhttpæœåŠ¡,æœ‰ä¸”é…ç½®äº†proxy(å¥½åƒä¸æ˜¯å€Ÿå£ä»£ç†è€Œæ˜¯httpsè¯ä¹¦ä¹‹ç±»çš„)æ—¶åˆ›å»ºhttpså¹¶åˆ›å»ºhttp2</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">createServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">import</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./server/index</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆ›å»ºä¸€ä¸ªnodejs httpæœåŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createServer</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// ä¼ é€’å‘½ä»¤è¡Œå¤„ç†åçš„å‚æ•°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">3001</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// å¼€å¯httpæœåŠ¡</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ‰“å°httpæœåŠ¡å¯åŠ¨æ—¥å¿—åŠç»“æœ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">httpæœåŠ¡å·²å¼€å¯ http://localhost:3001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">run</span><span style="color:#A6ACCD;">()</span></span></code></pre></div><p>ğŸ‘‡ <code>src/server/index.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> connect </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">connect</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// ç¼ºå°‘tsç±»å‹å£°æ˜ éœ€è¦æ‰‹åŠ¨ç¼–å†™</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolveHttpServer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">setClientErrorHandler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../http</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * åˆ›å»ºhttpæœåŠ¡ï¼Œå¹¶è¿”å›åŒ…å«å®ä¾‹ä¿¡æ¯çš„å¯¹è±¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> createServer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ ¹æ®ä¼ é€’çš„è·Ÿdevserverç›¸å…³çš„å‚æ•°å¤„ç†ä¸€ä¸‹ï¼Œåˆ›å»ºå‡ºhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">connetRes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">connect</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolveHttpServer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">connetRes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘‡ <code>src/http.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">Server</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HttpServer</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node:http</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * ä½¿ç”¨node:httpæ ¹æ®å‚æ•°æ’å…¥ä¸­é—´ä»¶å¹¶ç”ŸæˆhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">returns</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> resolveHttpServer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">app</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// TODO: åˆ¤æ–­å¦‚æœæ²¡æœ‰httpsOptionæ—¶åˆ›å»ºæ™®é€šhttpæœåŠ¡,æœ‰ä¸”é…ç½®äº†proxy(å¥½åƒä¸æ˜¯å€Ÿå£ä»£ç†è€Œæ˜¯httpsè¯ä¹¦ä¹‹ç±»çš„)æ—¶åˆ›å»ºhttpså¹¶åˆ›å»ºhttp2</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œæš‚æ—¶éƒ½åˆ›å»ºæ™®é€šhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">createServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">import</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node:http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// connet https://github.com/senchalabs/connect åº“è¿”å›çš„app,å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸­é—´ä»¶/functionalï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä½œä¸ºå‚æ•°ä¼ é€’ç»™httpä¾èµ–ï¼Œåˆ›å»ºhttpæœåŠ¡ï¼Œå°±å¯ä»¥è®©è¿™ä¸ªæœåŠ¡æ”¯æŒä¸­é—´ä»¶æ’ä»¶æœºåˆ¶çš„å†™æ³•</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¸ç›´æ¥ä½¿ç”¨koaè¿™ç§æœ¬èº«å°±æ”¯æŒä¸­é—´ä»¶çš„httpæœåŠ¡åº“çš„åŸå› æ˜¯</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ç”±äºå¤§å¤šæ•°é€»è¾‘åº”é€šè¿‡æ’ä»¶é’©å­å®ç°ï¼Œè€Œæ— éœ€ä½¿ç”¨ä¸­é—´ä»¶ï¼Œå› æ­¤å¯¹ä¸­é—´ä»¶çš„éœ€æ±‚å¤§å¤§å‡å°‘ã€‚å†…éƒ¨æœåŠ¡å™¨åº”ç”¨ç°åœ¨çœ‹èµ·æ¥åƒæ—§ç‰ˆçš„ connect å®ä¾‹ï¼Œè€Œä¸æ˜¯ Koaã€‚</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ğŸ‘† https://cn.vitejs.dev/guide/migration-from-v1.html#vue-support</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// çœ‹èµ·æ¥æ˜¯ä¸ºäº†å‡å°ä½“ç§¯</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;">  </span><span style="color:#82AAFF;">createServer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">app</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">setClientErrorHandler</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">HttpServer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">clientError</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,(</span><span style="color:#A6ACCD;font-style:italic;">err</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// headerå¤´å¤ªå¤§ï¼Ÿ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">HPE_HEADER_OVERFLOW</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#C3E88D;">        Server responded with status code 431.</span></span>
<span class="line"><span style="color:#C3E88D;">        see https://vitejs.dev/guide/troubleshooting.html#_431-request-header-fields-too-large</span></span>
<span class="line"><span style="color:#C3E88D;">      </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// resetæ—¶ä¸æŠ¥é”™</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ECONNRESET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>è·¯ç”±æ‹¦æˆªã€é‡å®šå‘æ ¹è·¯å¾„ä»¥åŠhmråŠŸèƒ½ï¼Œå‡é€šè¿‡æ’ä»¶æœºåˆ¶å®ç°</p><h2 id="åˆ›å»ºè‡ªå·±çš„serverå®ä¾‹-è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨httpçš„server" tabindex="-1">åˆ›å»ºè‡ªå·±çš„serverå®ä¾‹ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨httpçš„server <a class="header-anchor" href="#åˆ›å»ºè‡ªå·±çš„serverå®ä¾‹-è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨httpçš„server" aria-label="Permalink to &quot;åˆ›å»ºè‡ªå·±çš„serverå®ä¾‹ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨httpçš„server&quot;">â€‹</a></h2><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * åˆ›å»ºhttpæœåŠ¡ï¼Œå¹¶è¿”å›åŒ…å«å®ä¾‹ä¿¡æ¯çš„å¯¹è±¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> createServer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ ¹æ®ä¼ é€’çš„è·Ÿdevserverç›¸å…³çš„å‚æ•°å¤„ç†ä¸€ä¸‹ï¼Œåˆ›å»ºå‡ºhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">connect</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolveHttpServer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">connectRes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setClientErrorHandler</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// è®¾ç½®æœåŠ¡å™¨æŠ¥é”™å¤„ç†</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¾€nodeåˆ›å»ºçš„httpServerå®ä¾‹ä¸ŠæŒ‚è½½ æ’ä»¶æœºåˆ¶ã€hmræœºåˆ¶ã€ä¾èµ–å›¾è°±ç­‰åŠŸèƒ½ å½¢æˆä¸€ä¸ªviteServer ğŸ¤”koa/expresså…¶å®ä¹Ÿæ˜¯è¿™æ ·ï¼Ÿ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    listen</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">listen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// thisä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="åŸºç¡€ä¸­é—´ä»¶" tabindex="-1">åŸºç¡€ä¸­é—´ä»¶ <a class="header-anchor" href="#åŸºç¡€ä¸­é—´ä»¶" aria-label="Permalink to &quot;åŸºç¡€ä¸­é—´ä»¶&quot;">â€‹</a></h2><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// å¾€nodeåˆ›å»ºçš„httpServerå®ä¾‹ä¸ŠæŒ‚è½½ æ’ä»¶æœºåˆ¶ã€hmræœºåˆ¶ã€ä¾èµ–å›¾è°±ç­‰åŠŸèƒ½ å½¢æˆä¸€ä¸ªviteServer ğŸ¤”koa/expresså…¶å®ä¹Ÿæ˜¯è¿™æ ·ï¼Ÿ</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> server </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  httpServer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">listen</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> httpServer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">listen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;">(httpServer)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// useMiddleware</span></span>
<span class="line"><span style="color:#82AAFF;">setBaseMiddlewares</span><span style="color:#A6ACCD;">(defaultConfig</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">connectRes) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> server</span></span></code></pre></div><h3 id="ä»£ç†æœ¬åœ°ç›®å½•-ä¸ç»è¿‡ç¼–è¯‘çš„é™æ€èµ„æº" tabindex="-1">ä»£ç†æœ¬åœ°ç›®å½•(ä¸ç»è¿‡ç¼–è¯‘çš„é™æ€èµ„æº) <a class="header-anchor" href="#ä»£ç†æœ¬åœ°ç›®å½•-ä¸ç»è¿‡ç¼–è¯‘çš„é™æ€èµ„æº" aria-label="Permalink to &quot;ä»£ç†æœ¬åœ°ç›®å½•(ä¸ç»è¿‡ç¼–è¯‘çš„é™æ€èµ„æº)&quot;">â€‹</a></h3><ul><li>useçš„ä¸­é—´ä»¶æ ¼å¼æ˜¯ä¸€ä¸ªæœªæ‰§è¡Œçš„å‡½æ•°(req,res,next)=&gt;next()</li><li>è¿™é‡Œçš„ä¸­é—´ä»¶éƒ½æ˜¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ç”Ÿæˆä¸€ä¸ªå‡½æ•°</li></ul><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">servePublicMiddleware</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./static</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">setBaseMiddlewares</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">connectRes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// serve static files under /public</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// this applies before the transform middleware so that these files are served</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// as-is without transforms.</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">servePublicMiddleware</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><code>src/middleware/static.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> sirv </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sirv</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">servePublicMiddleware</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">dir</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å¯ä»¥è¿”å›ç®­å¤´å‡½æ•°ï¼Œè¿™é‡Œè¿”å›å…·åå‡½æ•°æ˜¯ä¸ºäº† The name is visible in debug logs via \`DEBUG=connect:dispatcher ...\`</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">viteServePublicMiddleware</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">next</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">sirvMiddlewareCreater</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sirv</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dir</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">sirvMiddlewareCreater</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">next</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘† ä½¿ç”¨ <code>sirv</code> çš„å¤–éƒ¨åº“</p><p>æ–°å»º <code>public/index.js</code>æ–‡ä»¶æµ‹è¯•ï¼Œè¿è¡Œ <code>pnpm dev</code></p><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221231222104.png" alt=""></p><h3 id="ä¸­é—´ä»¶å½¢å¼æ‹¦æˆªè¯·æ±‚è·¯å¾„-æŸ¥æ‰¾æœ¬åœ°èµ„æºè¿”å›" tabindex="-1">ä¸­é—´ä»¶å½¢å¼æ‹¦æˆªè¯·æ±‚è·¯å¾„ï¼ŒæŸ¥æ‰¾æœ¬åœ°èµ„æºè¿”å› <a class="header-anchor" href="#ä¸­é—´ä»¶å½¢å¼æ‹¦æˆªè¯·æ±‚è·¯å¾„-æŸ¥æ‰¾æœ¬åœ°èµ„æºè¿”å›" aria-label="Permalink to &quot;ä¸­é—´ä»¶å½¢å¼æ‹¦æˆªè¯·æ±‚è·¯å¾„ï¼ŒæŸ¥æ‰¾æœ¬åœ°èµ„æºè¿”å›&quot;">â€‹</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">transformMiddleware</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./transform</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">setBaseMiddlewares</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">connectRes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">servePublicMiddleware</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// main transform middleware</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">transformMiddleware</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">)) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><code>src/middlewares/transform/index.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">send</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../send</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">transformRequest</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../transformRequest</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transformMiddleware</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">serve</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">viteTransformMiddleware</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">next</span><span style="color:#89DDFF;">){</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">contend</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">transformRequest</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">url</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">send</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">contend</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">next</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><code>src/transformRequest.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * é€šè¿‡fileurl è¿”å›è½¬è¯‘åçš„æ–‡ä»¶å†…å®¹</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transformRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">è½¬è¯‘åçš„æ–‡ä»¶å†…å®¹</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// &lt;-- ç”±æ’ä»¶æœºåˆ¶æ¥è¯»å–æ–‡ä»¶å¹¶è½¬è¯‘</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><code>src/send.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * å°è£…ä¸€å±‚ä½¿ç”¨ä¸­é—´ä»¶çš„reså‘é€ç»“æœçš„å·¥å…·å‡½æ•°</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">content</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">statusCode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221231235744.png" alt=""></p><p>ğŸ‘† é™æ€æœåŠ¡å™¨çš„è·¯ç”±æœºåˆ¶å°±å®ç°äº†</p><p>æ ¹æ®urlåŠ è½½æ–‡ä»¶å†…å®¹ï¼Œæˆ‘ä»¬ä½¿ç”¨æ’ä»¶çš„å½¢å¼å®ç° å› æ­¤æˆ‘ä»¬è¿™é‡Œå…ˆä¸é€šè¿‡ <code>nodejs</code> çš„ <code>fsæ–‡ä»¶ç³»ç»Ÿæ¨¡å—</code> ç›´æ¥è¯»å–ç›¸åº”ç›®å½•çš„æ–‡ä»¶å†…å®¹</p><p>è€Œæ˜¯å®ç°æ’ä»¶æœºåˆ¶åå†æ¥<code>transformRequest</code>å‡½æ•°ä¸­è§¦å‘æ’ä»¶çš„è¯»å–æ–‡ä»¶å†…å®¹</p><h2 id="æ’ä»¶æœºåˆ¶" tabindex="-1">æ’ä»¶æœºåˆ¶ <a class="header-anchor" href="#æ’ä»¶æœºåˆ¶" aria-label="Permalink to &quot;æ’ä»¶æœºåˆ¶&quot;">â€‹</a></h2><p>å¾€è¿™ä¸ªåˆ›å»ºå¯åŠ¨é™æ€æœåŠ¡å™¨çš„è¿‡ç¨‹é‡ŒåŠ å…¥å„ç§æ’ä»¶æŒ‚è½½å’Œè°ƒç”¨çš„æœºåˆ¶</p><p>åœ¨serverä¸­åˆ›å»ºä¸€ä¸ªIoCæ§åˆ¶ä¸­å¿ƒï¼Œå¹¶ä¼ å…¥è·¯ç”±ä¸­é—´ä»¶ï¼Œè®©è·¯ç”±å‘½ä¸­ç›¸å…³IoCæ¨¡å—æ’ä»¶</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * åˆ›å»ºhttpæœåŠ¡ï¼Œå¹¶è¿”å›åŒ…å«å®ä¾‹ä¿¡æ¯çš„å¯¹è±¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> createServer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">({})</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ ¹æ®ä¼ é€’çš„è·Ÿdevserverç›¸å…³çš„å‚æ•°å¤„ç†ä¸€ä¸‹ï¼Œåˆ›å»ºå‡ºhttpæœåŠ¡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">connect</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolveHttpServer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">connectRes</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆ›å»ºæ’ä»¶è°ƒåº¦ä¸­å¿ƒ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createPluginContainer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">defaultConfig</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    listen</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">httpServer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">listen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">httpServer</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// thisä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// useMiddleware</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">setBaseMiddlewares</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">defaultConfig</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">connectRes</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘‡ <code>src/server/pluginContainer.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * åˆ›å»ºIoCä¾èµ–æ¨¡å—æ§åˆ¶ä¸­å¿ƒï¼Œå¤„ç†viteæ’ä»¶</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * å°±æ˜¯ä¸»ä½“å®ä¾‹ï¼Œæ•´ä¸ªdevserverçš„å„ç§åŠŸèƒ½éƒ½ç”±è¿™ä¸ªæ¨¡å—æ§åˆ¶ä¸­å¿ƒæŒ‚è½½ä»¥åŠæä¾›è°ƒç”¨</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createPluginContainer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">plugins</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">config</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">container</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    load</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">æ’ä»¶æœºåˆ¶å¤„ç†load</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">container</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘‡ <code>src/transformRequest.ts</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * é€šè¿‡fileurl è¿”å›è½¬è¯‘åçš„æ–‡ä»¶å†…å®¹</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transformRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#F07178;">()) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">è½¬è¯‘åçš„æ–‡ä»¶å†…å®¹</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>ğŸ‘† è‡³æ­¤è°ƒç”¨æ’ä»¶loadé€»è¾‘å®ç°ï¼Œå†å®ç°æŒ‚è½½é€»è¾‘</p><p>è¿™é‡Œå…ˆä¸å¤„ç†çš„viteæ’ä»¶æœºåˆ¶ä¸­çš„preã€postç­‰é…ç½®</p><p>çœ‹èµ·æ¥ä¸æ˜¯åœ¨loadçš„æ’ä»¶é‡ŒåšåŠ è½½èµ„æºçš„ è€Œæ˜¯åœ¨loadä¹‹å transformä¹‹å‰ -- è¿™æ˜¯rollupçš„æ’ä»¶ç”Ÿå‘½å‘¨æœŸæœºåˆ¶ï¼Œè¿˜æ˜¯è¦å…ˆç†Ÿæ‚‰rollup</p><p>ğŸ‘‡ <code>src/server/transformRequest.ts</code></p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> fs </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node:fs</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * é€šè¿‡fileurl è¿”å›è½¬è¯‘åçš„æ–‡ä»¶å†…å®¹</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">param</span><span style="color:#676E95;font-style:italic;"> </span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#676E95;font-style:italic;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transformRequest</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rootUrl</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// const fileUrl = path.resolve(url,rootUrl) // åªè¾“å‡ºæ–‡ä»¶ç›®å½•</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileUrl</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">rootUrl</span><span style="color:#89DDFF;">}\${</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">}\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æŒ‰æ’ä»¶æ‰§è¡Œé¡ºåºæ˜¯å…ˆæ‰§è¡Œæ’ä»¶ä¸­çš„loadï¼Œæ²¡æœ‰æ—¶æ‰æ‰§è¡Œè¯»å–æ–‡ä»¶</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">server</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">loadResult</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pluginContainer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">loadResult</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fileUrl</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf-8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">code</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>åœ¨æ ¹è·¯å¾„ä¸‹åˆ›å»º <code>a.html</code>æ¨¡æ¿æ–‡ä»¶ ä¸ç”¨index.htmlåŸå› æ˜¯ï¼Œnodejsé™æ€æœåŠ¡å™¨å¥½åƒé»˜è®¤ç›‘å¬äº†é‡å®šå‘åˆ°æ ¹è·¯å¾„index.html å½“è®¿é—® <code>http://localhost:3001</code> ä¼šè‡ªåŠ¨è¯»å–è·Ÿè·¯å¾„ä¸‹çš„index.html</p><p>æ­¤æ—¶è®¿é—®<code>http://localhost:3001/a.html</code> æµè§ˆå™¨æˆåŠŸæ‰“å¼€a.htmlçš„æ–‡ä»¶å†…å®¹</p><p>åœ¨a.htmlä¸­ç”¨esmåŠ è½½main.js</p><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230101161040.png" alt=""></p><h2 id="æ ¹è·¯å¾„é‡å®šå‘connectä¸­é—´ä»¶" tabindex="-1">æ ¹è·¯å¾„é‡å®šå‘connectä¸­é—´ä»¶ <a class="header-anchor" href="#æ ¹è·¯å¾„é‡å®šå‘connectä¸­é—´ä»¶" aria-label="Permalink to &quot;æ ¹è·¯å¾„é‡å®šå‘connectä¸­é—´ä»¶&quot;">â€‹</a></h2><p>ä¸­é—´ä»¶ä¸æ˜¯viteçš„containeræ’ä»¶ï¼Œä¸è¦ææ··äº†</p><p>ä¸­é—´ä»¶çš„æ´‹è‘±åœˆæ‰§è¡Œé¡ºåºæ˜¯nextå‰çš„æŒ‰æŒ‚è½½é¡ºåºæ‰§è¡Œï¼Œnextåçš„å€’åº</p><p>é‚£é‡å®šå‘ä¸­é—´ä»¶åº”è¯¥è¦åœ¨è·¯ç”±ä¸­é—´ä»¶å‰æ‰å¯¹ï¼Œå¦åˆ™å…ˆè¿›å…¥è·¯ç”±ä¸­é—´ä»¶å°±å»è¯»å–<code>/</code>è€ŒæŠ¥é”™äº†</p><p>ä½†æ˜¯viteçš„é‡å®šå‘ä¸­é—´ä»¶åœ¨åé¢ï¼Ÿï¼Ÿæ€ä¹ˆåšåˆ°çš„TODO: æˆ‘ä»¬å…ˆæ”¾å‰é¢</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">transformMiddleware</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./transform</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">setBaseMiddlewares</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">connectRes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">servePublicMiddleware</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">publicDir</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// html fallback</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">htmlFallbackMiddleware</span><span style="color:#F07178;">()) </span><span style="color:#676E95;font-style:italic;">// &lt;-- this</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// main transform middleware</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">connectRes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">transformMiddleware</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p><code>connect-history-api-fallback</code> è¿™nodejsåº“å¯ä»¥ç ”ç©¶ä¸€ä¸‹ å¥½åƒéƒ½æ˜¯äº›åˆ¤æ–­httpè¯·æ±‚htmlèµ„æºçš„headerä¿¡æ¯åˆ¤æ–­ æœ‰æ›´å®Œå–„çš„å¥å£®åº¦</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> history </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">connect-history-api-fallback</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">htmlFallbackMiddleware</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">middlewareFn</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">history</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    index</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/a.html</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">middlewareFn</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="æ”¯æŒts" tabindex="-1">æ”¯æŒts <a class="header-anchor" href="#æ”¯æŒts" aria-label="Permalink to &quot;æ”¯æŒts&quot;">â€‹</a></h2><blockquote><p>TODO: æš‚åœæ–½å·¥ï¼Œå…ˆæŠŠviteä½¿ç”¨æ–‡æ¡£è¿‡ä¸€éå¹¶è®°å½•ç¬”è®°åï¼Œé‡æ–°å¼€å§‹æºç åˆ†æ</p></blockquote><h3 id="æ’ä»¶transformé’©å­æ‰§è¡Œ" tabindex="-1">æ’ä»¶transformé’©å­æ‰§è¡Œ <a class="header-anchor" href="#æ’ä»¶transformé’©å­æ‰§è¡Œ" aria-label="Permalink to &quot;æ’ä»¶transformé’©å­æ‰§è¡Œ&quot;">â€‹</a></h3><h3 id="ä½¿ç”¨esbuild" tabindex="-1">ä½¿ç”¨ESbuild <a class="header-anchor" href="#ä½¿ç”¨esbuild" aria-label="Permalink to &quot;ä½¿ç”¨ESbuild&quot;">â€‹</a></h3><h2 id="æ”¯æŒjson" tabindex="-1">æ”¯æŒjson <a class="header-anchor" href="#æ”¯æŒjson" aria-label="Permalink to &quot;æ”¯æŒjson&quot;">â€‹</a></h2><h2 id="æ”¯æŒcss" tabindex="-1">æ”¯æŒcss <a class="header-anchor" href="#æ”¯æŒcss" aria-label="Permalink to &quot;æ”¯æŒcss&quot;">â€‹</a></h2><h2 id="æ€»ä½“æ­¥éª¤" tabindex="-1">æ€»ä½“æ­¥éª¤ <a class="header-anchor" href="#æ€»ä½“æ­¥éª¤" aria-label="Permalink to &quot;æ€»ä½“æ­¥éª¤&quot;">â€‹</a></h2><ul><li>åˆ›å»ºæœ¬åœ°æ–‡ä»¶ä¿®æ”¹ç›‘å¬å™¨ chokidar</li><li>åˆ›å»ºä¾èµ–å›¾è°±(æ‰«ææœªæ‰§è¡Œçš„æ‰€æœ‰æ–‡ä»¶ï¼Ÿè¿˜æ˜¯è¿è¡Œæ—¶åˆ›å»ºï¼Ÿ</li><li>åˆ›å»ºæ’ä»¶è°ƒåº¦ä¸­å¿ƒ</li><li>å¾€nodeåˆ›å»ºçš„httpServerå®ä¾‹ä¸ŠæŒ‚è½½ æ’ä»¶æœºåˆ¶ã€hmræœºåˆ¶ã€ä¾èµ–å›¾è°±ç­‰åŠŸèƒ½ å½¢æˆä¸€ä¸ªviteServer ğŸ¤”koa/expresså…¶å®ä¹Ÿæ˜¯è¿™æ ·ï¼Ÿ</li></ul>`,77),t=[o];function e(c,r,y,F,D,i){return n(),a("div",null,t)}const d=s(p,[["render",e]]);export{C as __pageData,d as default};
