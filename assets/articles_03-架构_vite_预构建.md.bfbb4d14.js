import{_ as s,o as a,c as n,V as l}from"./chunks/framework.b450deef.js";const A=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"articles/03-æ¶æ„/vite/é¢„æ„å»º.md","filePath":"articles/03-æ¶æ„/vite/é¢„æ„å»º.md"}'),o={name:"articles/03-æ¶æ„/vite/é¢„æ„å»º.md"},p=l(`<p><a href="https://juejin.cn/post/7090201071464742949" target="_blank" rel="noreferrer">è¯¦è§£ Vite é¢„æ„å»ºæµç¨‹</a></p><p>é¢„æ„å»ºè¿™ä¸ªåè¯å®¹æ˜“è®©äººä¸æ¸…æ¥šåˆ°åº•å‘ç”Ÿåœ¨ä»€ä¹ˆé˜¶æ®µï¼Œæˆ‘ä»¬å…ˆæŠ›ä¸‹è¿™ä¸ªè¯çš„å­—é¢æ„æ€</p><h2 id="é¢„æ„å»º-do-what" tabindex="-1">é¢„æ„å»º do what <a class="header-anchor" href="#é¢„æ„å»º-do-what" aria-label="Permalink to &quot;é¢„æ„å»º do what&quot;">â€‹</a></h2><ul><li>ä»…å‘ç”Ÿåœ¨ dev é˜¶æ®µï¼ŒViteDevServer æä¾›çš„åŠŸèƒ½</li><li>åˆ©ç”¨ esbuild è½¬åŒ– CommonJS/UMD --&gt; ESM <ul><li>éš¾ç‚¹åœ¨äºè½¬åŒ–åçš„ä»£ç è¦æ”¯æŒ <code>import xx {xx} from &#39;xx&#39;</code> å³ï¼šä¸èƒ½ç®€å•çš„æŠŠ <code>module.exports</code> æ›¿æ¢æˆ <code>export default</code></li><li>åœ¨ build é˜¶æ®µï¼Œåˆ™ç”± rollup çš„ @rollup/plugin-commonjs æ’ä»¶åšè½¬åŒ–</li><li>ğŸ‘† rollup çš„å®—æ—¨å°±æ˜¯åˆ©ç”¨ ESM çš„ tree-shaking å®ç°æœ€å°åŒ–æ‰“åŒ…åä»£ç ï¼Œå› æ­¤æœ¬èº«å°±å¿…é¡»æœ‰å®Œå–„çš„è½¬åŒ– plugin</li></ul></li><li>æ•´åˆå†…éƒ¨ä¾èµ–åˆ°1ä¸ªæ–‡ä»¶(ğŸ¤”ä¹Ÿæ˜¯ç”¨esbuildå—ï¼Ÿ)å¦‚ <code>import { debounce } from &#39;lodash-es&#39;</code> ä¼šå‘å‡º 600 å¤šä¸ªæ¨¡å—è¯·æ±‚ <ul><li>ğŸ¤” æ€ä¹ˆç¡®å®šå“ªäº›æ¨¡å—å±äºä¸€ä¸ªæ¨¡å—ï¼Œnode_modulesçš„ä¾èµ–è¿˜å¥½ï¼Œå¦‚æœæ˜¯ä¸šåŠ¡ä»£ç çš„å…¬å…±å‡½æ•°ä¾èµ–ä¹Ÿä¼šè¢«æ•´åˆèµ·æ¥å—ï¼Ÿ</li></ul></li><li>ç¼“å­˜é¢„æ„å»ºçš„ç»“æœï¼Œæ›´æ–°æ—¶æœºæ˜¯ï¼šä¾èµ–å…³ç³»å‘ç”Ÿå˜åŒ–(æ–°å¼•å…¥èµ„æºæˆ–åˆ é™¤å¼•å…¥èµ„æºæˆ–ä¿®æ”¹å¼•å…¥èµ„æºè·¯å¾„) <ul><li>ğŸ‘†å¦‚æœ ä¸šåŠ¡ä»£ç  ä¹Ÿä¼šæ•´åˆèµ·æ¥çš„ HMR æ²¡åŠæ³•åšå§ï¼Œå› ä¸ºç¼“å­˜ä½äº†è¿™ä¸ªé¢„æ„å»ºçš„ç»“æœï¼Œä¾èµ–å…³ç³»ä¹Ÿæ²¡å˜(åªæ˜¯å˜äº†å†…å®¹)</li><li>TODO: å»ºç«‹ä¸€ä¸ªåŸç”Ÿjsçš„viteé¡¹ç›®ï¼Œå¼•å…¥loadshå’Œæ·±å±‚æ¨¡å—çš„ä¸šåŠ¡ä»£ç ï¼ŒæŸ¥çœ‹æµè§ˆå™¨ networker</li></ul></li></ul><h3 id="monorepo-åœºæ™¯" tabindex="-1">Monorepo åœºæ™¯ <a class="header-anchor" href="#monorepo-åœºæ™¯" aria-label="Permalink to &quot;Monorepo åœºæ™¯&quot;">â€‹</a></h3><p>bare import ä¸æ˜¯ node_modules ä¸ä¼šå˜åŒ–çš„ä¾èµ–ï¼Œè€Œæ˜¯æ­£åœ¨å¼€å‘ä¸­çš„æºç  æ­¤æ—¶å¸Œæœ›çš„æ˜¯è¿™ä¸ªä¾èµ–ä¸è¦ç»è¿‡ é¢„ç¼–è¯‘ è€Œæ˜¯å’Œå…¶ä»–ä¸šåŠ¡ä»£ç ä¸€æ ·</p><p>ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒMonorepo çš„ä¾èµ–ä¸æ˜¯ESM (åŸºæœ¬ä¸ä¼šå§ã€‚ã€‚ã€‚)ï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®è®© vite å¯¹è¿™ä¸ª Monorepo åº“åš é¢„æ„å»º</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">defineConfig</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">optimizeDeps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">include</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">monorepo-dep</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">build</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">commonjsOptions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">include</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">monorepo-dep</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>é‚£ä¹ˆæ­¤æ—¶ vite å°±ä¼šæŠŠ monorepo-dep å½“ä½œ node_modules çš„ä¾èµ–å¤„ç†ï¼Œå¹¶ä¸”ç¼“å­˜ è€Œ node_modules ä¾èµ–çš„ç¼“å­˜æƒ³è¦é‡æ–° é¢„æ„å»º éœ€è¦packages.jsonä¾èµ–ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè§¦å‘ è€Œ monorepo-dep è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æƒ³è¦ç”Ÿæ•ˆå°±åªèƒ½é‡å¯ vite æœåŠ¡ï¼Œå¹¶ä¸”å¼€å¯å¼ºåˆ¶ focus æ¨¡å¼ <code>pnpm dev --focus</code></p><h2 id="é¢„æ„å»ºæ—¶æœº" tabindex="-1">é¢„æ„å»ºæ—¶æœº <a class="header-anchor" href="#é¢„æ„å»ºæ—¶æœº" aria-label="Permalink to &quot;é¢„æ„å»ºæ—¶æœº&quot;">â€‹</a></h2><ul><li>é¢„æ„å»ºå‘ç”Ÿç¼–è¯‘æ—¶ <ul><li>TODO:å¾…ç¡®è®¤ ç¼–è¯‘æ—¶æ‰«ææ‰€æœ‰ä»£ç çš„ import è¯­å¥åˆ†æå‡ºéœ€è¦é¢„æ„å»ºçš„æ¨¡å—ï¼Œå¹¶æ‰§è¡Œ</li><li>å½“ import è¯­å¥ï¼Œæ˜¯åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°è·¯ç”±æ‰ç”Ÿæˆçš„æ—¶å€™ï¼Œæºç ä¸­æ²¡æœ‰è¿™ä¸ª importï¼Œåˆ™åœ¨å¯åŠ¨ç¼–è¯‘æ—¶ä¸ä¼š é¢„æ„å»º åˆ°</li><li>ğŸ‘† è‡ªåŠ¨import <a href="https://github.com/antfu/unplugin-auto-import" target="_blank" rel="noreferrer">unplugin-auto-import github</a> çš„æ’ä»¶æ˜¯è¿™ç§æƒ…å†µå—ï¼Ÿ</li><li>ä½†æ˜¯è¿è¡Œæ—¶ï¼Œèƒ½ç›‘æµ‹åˆ°ç”Ÿæˆçš„ import è¯­å¥å¹¶è§¦å‘é‡æ–° æ„å»º</li><li>ç”¨ <code>optimizeDeps.include</code> æˆ– <code>optimizeDeps.exclude</code> é…ç½®ï¼Œæ‰‹åŠ¨æŒ‡å®šå¯åŠ¨ç¼–è¯‘æ—¶éœ€è¦é¢„ç¼–è¯‘çš„æ¨¡å—(å³ä½¿æºç ä¸­æ²¡æœ‰import)</li><li>exclude æ’é™¤åˆ™ç”¨äºè¿è¡Œæ—¶è§¦å‘é‡æ–° æ„å»ºï¼Œå¦‚è¿™ä¸ªæ¨¡å—æ˜¯ ESM ä¸”ä¾èµ–æ¨¡å—ä¸å¤š(é¢„æ„å»ºä¸»è¦ä½œç”¨å‘æŒ¥ä¸äº†)æ—¶ï¼Œå¯ä»¥æ’é™¤æ‰ï¼Œçœå»è¿™æ¬¡é‡æ–° æ„å»º</li></ul></li><li>è¿è¡Œæ—¶åªè´Ÿè´£ç›‘å¬æ˜¯å¦éœ€è¦é‡æ–° æ„å»º - ğŸ¤” è¿è¡Œæ—¶è§¦å‘é‡æ–°æ„å»ºç›¸å½“äºé‡å¯ vite å—ï¼Ÿé¡µé¢ä¸ä¼š reload ï¼Ÿ</li></ul><blockquote><p>é‡æ–°æ„å»º !== é‡æ–°é¢„æ„å»º re-bundle !== re-run pre-bundle</p></blockquote><h2 id="é‡æ–°é¢„æ„å»ºæ—¶æœº" tabindex="-1">é‡æ–°é¢„æ„å»ºæ—¶æœº <a class="header-anchor" href="#é‡æ–°é¢„æ„å»ºæ—¶æœº" aria-label="Permalink to &quot;é‡æ–°é¢„æ„å»ºæ—¶æœº&quot;">â€‹</a></h2><h3 id="vite-è‡ªåŠ¨è§¦å‘" tabindex="-1">vite è‡ªåŠ¨è§¦å‘ <a class="header-anchor" href="#vite-è‡ªåŠ¨è§¦å‘" aria-label="Permalink to &quot;vite è‡ªåŠ¨è§¦å‘&quot;">â€‹</a></h3><p>ä¹Ÿå°±æ˜¯ æ›´æ–°é¢„æ„å»ºç¼“å­˜çš„æ—¶æœº</p><ul><li>Package manager lockfile content, e.g. <code>package-lock.json</code>, <code>yarn.lock</code>, <code>pnpm-lock.yaml</code> or <code>bun.lockb</code></li><li>Patches folder modification time ğŸ¤” è¡¥ä¸æ–‡ä»¶å¤¹ï¼Ÿï¼Ÿï¼Ÿ</li><li>Relevant fields in your <code>vite.config.js</code>, if present.</li><li><code>NODE_ENV</code> value.</li></ul><h3 id="æ‰‹åŠ¨è§¦å‘" tabindex="-1">æ‰‹åŠ¨è§¦å‘ <a class="header-anchor" href="#æ‰‹åŠ¨è§¦å‘" aria-label="Permalink to &quot;æ‰‹åŠ¨è§¦å‘&quot;">â€‹</a></h3><ul><li><code>pnpm dev --force</code></li><li>åˆ é™¤ <code>node_modules/.vite/</code> ç›®å½•ï¼Œåé‡å¯ vite</li></ul><h3 id="ç¼“å­˜å¸¦æ¥çš„ç‰¹æ®Šæ“ä½œ" tabindex="-1">ç¼“å­˜å¸¦æ¥çš„ç‰¹æ®Šæ“ä½œ <a class="header-anchor" href="#ç¼“å­˜å¸¦æ¥çš„ç‰¹æ®Šæ“ä½œ" aria-label="Permalink to &quot;ç¼“å­˜å¸¦æ¥çš„ç‰¹æ®Šæ“ä½œ&quot;">â€‹</a></h3><p>å› ä¸º node_modules è§†ä¸ºä¸å˜åŒ–çš„æ¨¡å—ï¼Œç»è¿‡ é¢„æ„å»º ä¹‹åé™¤äº†åœ¨é¡¹ç›®ç›®å½• nodejs ç¯å¢ƒæœ‰ç¼“å­˜ä¹‹å¤– viteDevServer ä¸ºè¿™ä¸ªèµ„æºåšäº†æµè§ˆå™¨ HTTP å¼ºç¼“å­˜å’Œ url-query hashï¼Œåªæœ‰è§¦å‘ re-run pre-bundle æ‰ä¼šæ›´æ–°åˆ°è¿™äº›æµè§ˆå™¨å¼ºç¼“å­˜çš„èµ„æº url-query hash å¦‚æœå¸Œæœ›ç›´æ¥ä¿®æ”¹ node_modules ä¸­çš„ä»£ç æ¥è°ƒè¯•é¡¹ç›®ï¼ˆæ­¤æ—¶ä¸ä¼šè§¦å‘è‡ªåŠ¨ re-run pre-bundle) å› æ­¤éœ€è¦æ‰‹åŠ¨é‡å¯ vite è§¦å‘ focusï¼Œå¹¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜(ğŸ¤” æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æ˜¯å› ä¸ºæ­¤æ—¶çš„hashä¸ä¼šå˜ï¼Ÿç”Ÿæˆhashçš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿpackage.json å—)</p><h2 id="ç›¸å…³é…ç½®é¡¹" tabindex="-1">ç›¸å…³é…ç½®é¡¹ <a class="header-anchor" href="#ç›¸å…³é…ç½®é¡¹" aria-label="Permalink to &quot;ç›¸å…³é…ç½®é¡¹&quot;">â€‹</a></h2><p><a href="https://vitejs.dev/config/dep-optimization-options.html#optimizedeps-include" target="_blank" rel="noreferrer">viteå®˜æ–¹æ–‡æ¡£config - Dep Optimization Options</a></p><p>viteåœ¨å¯åŠ¨ <code>listen</code> çš„æ—¶å€™ï¼Œå…ˆæ‰§è¡Œ 1. esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å• 2. esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶ï¼Œæ‰ä¼šå¯åŠ¨æœåŠ¡</p><p>æ‰€ä»¥è™½ç„¶è¯´ <code>vite</code> è¯´devé˜¶æ®µéƒ½æ˜¯æ‡’åŠ è½½å¯åŠ¨æ²¡æœ‰æ‰“åŒ…æ­¥éª¤ï¼Œå…¶å®æ˜¯é”™çš„ æ—¢ç„¶ <code>esbuild</code> å¯ä»¥å®ç°æ‰“åŒ…ï¼Œé‚£ buildé˜¶æ®µ ä¸ºä»€ä¹ˆä¸å¹²è„†ç”¨ <code>esbuild</code>ï¼Œè€Œæ˜¯ç”¨ <code>rollup</code> å®˜æ–¹æ–‡æ¡£ä¹Ÿè§£é‡Šäº† <code>esbuild</code> ç›®å‰æ‰“åŒ…åŠŸèƒ½è¿˜ä¸å®Œå–„ï¼Œä¸åƒ <code>rollup</code> åŸºæœ¬ä»€ä¹ˆéƒ½èƒ½æ‰“åŒ…</p><h2 id="åˆ›å»ºé¡¹ç›®" tabindex="-1">åˆ›å»ºé¡¹ç›® <a class="header-anchor" href="#åˆ›å»ºé¡¹ç›®" aria-label="Permalink to &quot;åˆ›å»ºé¡¹ç›®&quot;">â€‹</a></h2><p>ğŸ‘‡ <code>esbuild_pre_bundle/serve.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Koa </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">koa</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> koaStatic </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">koa-static</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileURLToPath</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">URL</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node:url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// ç”¨äºé…ç½®ç›®å½•åˆ«å</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> app </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Koa</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// é™æ€èµ„æº</span></span>
<span class="line"><span style="color:#A6ACCD;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">koaStatic</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">fileURLToPath</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">URL</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">url))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">3001</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">build success</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">esbuild pre bundle</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./index.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// index.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./src/a.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(a)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// a.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./a_1.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// a_1.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./a_1_1.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// a_1_1.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a_1_1</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104155749.png" alt=""></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// import { a } from &#39;./src/a.js&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">throttle</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash-es</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(throttle)</span></span></code></pre></div><blockquote><p>Uncaught TypeError: Failed to resolve module specifier &quot;lodash-es&quot;. Relative references must start with either &quot;/&quot;, &quot;./&quot;, or &quot;../&quot;. ğŸ‘† esm ä¸æ”¯æŒ bare improt</p></blockquote><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">esbuild pre bundle</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">importmap</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    {</span></span>
<span class="line"><span style="color:#A6ACCD;">      &quot;imports&quot;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;lodash-es&quot;: &quot;/node_modules/lodash-es/lodash.js&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./index.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104160950.png" alt=""></p><h3 id="vanilla-vite" tabindex="-1">Vanilla Vite <a class="header-anchor" href="#vanilla-vite" aria-label="Permalink to &quot;Vanilla Vite&quot;">â€‹</a></h3><p>ä¸ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ <img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104161944.png" alt=""></p><p>lodash-es ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ <img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104162153.png" alt=""></p><h2 id="esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å•" tabindex="-1">esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å• <a class="header-anchor" href="#esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å•" aria-label="Permalink to &quot;esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å•&quot;">â€‹</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">scanImports</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ç¡®è®¤å…¥å£ï¼Œè¿™é‡Œå†™æ­»ä¸æ”¯æŒé…ç½®ï¼Œä¹Ÿä¸æ”¯æŒå¤šå…¥å£</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">entry</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./index.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// åˆ›å»º esbuildScanPlugin æ’ä»¶</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">depImports</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// keyä¸º bare import, value ä¸º absolute url</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">plugin</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createEsbuildScanPlugin</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">depImports</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">build</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    absWorkingDir</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    write</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    entryPoints</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#A6ACCD;">entry</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ä¼ å…¥å…¥å£</span></span>
<span class="line"><span style="color:#F07178;">    bundle</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">esm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    logLevel</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    plugins</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#A6ACCD;">plugin</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// Vite æ”¯æŒé…ç½®å…¶ä»–æ’ä»¶</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// outfile: &#39;dist.js&#39;,</span></span>
<span class="line"><span style="color:#F07178;">    allowOverwrite</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">depImports</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * esbuild çš„ plugin ä¹Ÿæ˜¯å®šä¹‰ä¸€ä¸ªåŒ…å« name å’Œ setup å‡½æ•°çš„å¯¹è±¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * setupå‡½æ•°ä¼šè¢« esbuild æ³¨å…¥ä¸€ä¸ª build å¯¹è±¡å‚æ•°ï¼Œå¾€è¿™é‡Œé¢æŒ‚è½½ä¸œè¥¿å°±èƒ½è‡ªå®šä¹‰ esbuild çš„å¤„ç†é€»è¾‘</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createEsbuildScanPlugin</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">depImports</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dep-scan</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    setup</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">build</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">build</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onResolve</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> filter</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;font-style:italic;">^</span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">\\w@</span><span style="color:#89DDFF;">][^</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">]/</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">async</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">({</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">importer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">})</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// è·å– ç¬¬ä¸‰æ–¹æ¨¡å—çš„ç»å¯¹è·¯å¾„</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// const resolved = await resolve(path, importer)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">afterUrl</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fileURLToPath</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">URL</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./node_modules/lodash-es/lodash.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">url</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dep-scan check this</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">afterUrl</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">lodash-es</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">afterUrl</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ERROR: Plugin &quot;dep-scan&quot; returned a non-absolute path: lodash-es (set a namespace if this is not a file path)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// åªå¯¹ node_modules ç›®å½•ä¸‹çš„æ¨¡å—ç”¨ esbuild å¤„ç†</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">resolved</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// è®°å½• pre-bundle æ¸…å•</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// ğŸ¤” TODO: å¦‚æœåªæ˜¯ä¸ºäº†è®°å½•æ¸…å•ç»™åé¢çš„esbuild è½¬è¯‘ï¼Œ ä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½® trueï¼Œè½¬è¯‘æ­¥éª¤æœ¬èº«å°±ä¼šè¾“å‡ºç›¸åº”çš„æ–‡ä»¶å§</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// æ‰«æè¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç†å…¶ä»–åç¼€æ–‡ä»¶çš„å§ï¼Œæ•´åˆæ‰“åŒ…ä¸»è¦è¿˜æ˜¯é åé¢ä¸€æ­¥</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">depImports</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">path</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolved</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œåªæ˜¯ä¸ºäº†è¿”å› external: true é€‰é¡¹</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ¨¡å—è·¯å¾„</span></span>
<span class="line"><span style="color:#F07178;">            external</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å…¥å£æ–‡ä»¶å¤–çš„å±äº node_modules çš„æ¨¡å—è®¾ç½®ä¸º true</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶" tabindex="-1">esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶ <a class="header-anchor" href="#esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶" aria-label="Permalink to &quot;esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶&quot;">â€‹</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doBuild</span><span style="color:#89DDFF;">({</span><span style="color:#A6ACCD;font-style:italic;">depImports</span><span style="color:#89DDFF;">})</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// esubild çš„åŒä¸€ä¸ª api build å‚æ•°åŠ ä¸Š metafile: true å¯ä»¥å¾—åˆ° res.metafile</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">build</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    absWorkingDir</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    entryPoints</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">depImports</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    bundle</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// è¿™é‡Œä¸º trueï¼Œå¯ä»¥å°†æœ‰è®¸å¤šå†…éƒ¨æ¨¡å—çš„ ESM ä¾èµ–å…³ç³»è½¬æ¢ä¸ºå•ä¸ªæ¨¡å—</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">esm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// target: config.build.target || undefined,</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// external: config.optimizeDeps?.exclude, // é…ç½®é¡¹ æ’é™¤é¢„ç¼–è¯‘</span></span>
<span class="line"><span style="color:#F07178;">    logLevel</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    splitting</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    sourcemap</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    outdir</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fileURLToPath</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">URL</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./dist</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">meta</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">url</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    platform</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">browser</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    ignoreAnnotations</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    metafile</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// define, // ç¯å¢ƒå˜é‡è½¬çœŸå®å€¼å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#F07178;">    plugins</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// console.log(&#39;res.metafile&#39;, result.metafile)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doBuild</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">scanImports</span><span style="color:#A6ACCD;">())</span></span></code></pre></div><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191005.png" alt=""></p><p><img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191236.png" alt=""></p><p>æ‰‹åŠ¨ä¿®æ”¹å¼•ç”¨ä¸º <code>import { throttle } from &#39;./dist/lodash-es.js&#39;</code>(ä¸ä¼šå‘½ä¸­ æ”¶é›†ä¾èµ–æ¸…å•çš„é€»è¾‘ï¼Œå› æ­¤ä¸ä¼šé‡å¤æ‰“åŒ…) <img src="https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191625.png" alt=""></p><h2 id="è¯·æ±‚è·¯å¾„æ˜ å°„" tabindex="-1">è¯·æ±‚è·¯å¾„æ˜ å°„ <a class="header-anchor" href="#è¯·æ±‚è·¯å¾„æ˜ å°„" aria-label="Permalink to &quot;è¯·æ±‚è·¯å¾„æ˜ å°„&quot;">â€‹</a></h2><p>bare import è¯·æ±‚ä¼šè¢«viteè·¯ç”±æ‹¦æˆªé‡å†™ä¸ºè®¿é—®é¢„æ„å»ºç›®å½•çš„ç›¸åº”èµ„æº</p><p>è¿™ä¸€æ­¥ä¸éš¾å®ç° å› ä¸ºå·²ç»æ”¶é›†åˆ°äº†: keyä¸º bare import, valueä¸ºå®Œæ•´è·¯å¾„ çš„ä¾èµ–æ¸…å•</p><p>éš¾çš„æ˜¯è¦ç»™è¿™ä¸ªè®¿é—®è®¾ç½® qurey hash å¹¶ä¸”èƒ½æ›´æ–°</p><h2 id="ç¼“å­˜åŠæ›´æ–°é€»è¾‘" tabindex="-1">ç¼“å­˜åŠæ›´æ–°é€»è¾‘ <a class="header-anchor" href="#ç¼“å­˜åŠæ›´æ–°é€»è¾‘" aria-label="Permalink to &quot;ç¼“å­˜åŠæ›´æ–°é€»è¾‘&quot;">â€‹</a></h2><p>TODO: <a href="https://keqingrong.cn/blog/2021-11-24-commonjs-compatibility-with-vite/" target="_blank" rel="noreferrer">ä½¿ç”¨ Vite è¿‡ç¨‹ä¸­é‡åˆ°çš„ CommonJS å…¼å®¹é—®é¢˜</a></p><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1">å‚è€ƒèµ„æ–™ <a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-label="Permalink to &quot;å‚è€ƒèµ„æ–™&quot;">â€‹</a></h2><ul><li><a href="https://juejin.cn/post/7125424862050402341" target="_blank" rel="noreferrer">èŠä¸€èŠ Vite çš„é¢„æ„å»ºå’ŒäºŒæ¬¡é¢„æ„å»º</a></li><li><a href="https://juejin.cn/post/7047479540850884645" target="_blank" rel="noreferrer">Vite æºç ï¼ˆå…«ï¼‰Vite çš„é¢„æ„å»ºåŸç†</a></li></ul>`,54),e=[p];function t(c,r,F,y,D,i){return a(),n("div",null,e)}const d=s(o,[["render",t]]);export{A as __pageData,d as default};
